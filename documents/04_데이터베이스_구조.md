# 04. Sensor Game Hub - ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

> **ì‘ì„±ì¼**: 2025-01-10
> **ë²„ì „**: v6.1.0
> **ëª©ì **: Supabase PostgreSQL ì™„ì „ ë¶„ì„

---

## ğŸ“‹ ëª©ì°¨

1. [ë°ì´í„°ë² ì´ìŠ¤ ê°œìš”](#1-ë°ì´í„°ë² ì´ìŠ¤-ê°œìš”)
2. [í…Œì´ë¸” êµ¬ì¡°](#2-í…Œì´ë¸”-êµ¬ì¡°)
3. [RLS ì •ì±…](#3-rls-ì •ì±…)
4. [pgvector ë²¡í„° ê²€ìƒ‰](#4-pgvector-ë²¡í„°-ê²€ìƒ‰)
5. [ì¸ë±ìŠ¤ ì „ëµ](#5-ì¸ë±ìŠ¤-ì „ëµ)
6. [íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜](#6-íŠ¸ë¦¬ê±°-ë°-í•¨ìˆ˜)

---

## 1. ë°ì´í„°ë² ì´ìŠ¤ ê°œìš”

### 1.1 Supabase ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase í”Œë«í¼                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  PostgreSQL 15  â”‚  â”‚   Auth Service  â”‚          â”‚
â”‚  â”‚  + pgvector     â”‚  â”‚   (JWT ê¸°ë°˜)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                     â”‚                   â”‚
â”‚           â”‚                     â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     Storage     â”‚  â”‚    Realtime     â”‚          â”‚
â”‚  â”‚  (ê²Œì„ íŒŒì¼)     â”‚  â”‚   (WebSocket)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

```sql
-- í”„ë¡œì íŠ¸ ì •ë³´
Project ID: rwkgktwdljsddowcxphc
Region: ap-northeast-2 (ì„œìš¸)
PostgreSQL Version: 15.1

-- í™•ì¥ ê¸°ëŠ¥
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";      -- UUID ìƒì„±
CREATE EXTENSION IF NOT EXISTS "pgcrypto";       -- ì•”í˜¸í™”
CREATE EXTENSION IF NOT EXISTS "vector";         -- pgvector (RAGìš©)
```

### 1.3 í…Œì´ë¸” ëª©ë¡

| í…Œì´ë¸”ëª… | ìš©ë„ | í–‰ ìˆ˜ (ì˜ˆìƒ) |
|---------|------|-------------|
| `generated_games` | AI ìƒì„± ê²Œì„ ë©”íƒ€ë°ì´í„° | ~100 |
| `game_versions` | ê²Œì„ ë²„ì „ ê´€ë¦¬ | ~100 |
| `game_knowledge` | RAG ë²¡í„° ì €ì¥ì†Œ | ~400 |
| `auth.users` | ì‚¬ìš©ì ì¸ì¦ (Supabase ê¸°ë³¸) | ~50 |

---

## 2. í…Œì´ë¸” êµ¬ì¡°

### 2.1 generated_games í…Œì´ë¸”

**ìš©ë„**: AIê°€ ìƒì„±í•œ ê²Œì„ì˜ ë©”íƒ€ë°ì´í„° ì €ì¥

```sql
CREATE TABLE public.generated_games (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    game_id TEXT UNIQUE NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    game_type TEXT NOT NULL CHECK (game_type IN ('solo', 'dual', 'multi')),
    genre TEXT,
    storage_path TEXT NOT NULL,
    thumbnail_url TEXT,
    play_count INTEGER DEFAULT 0,
    creator_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì½”ë©˜íŠ¸
COMMENT ON TABLE public.generated_games IS 'AI ìƒì„± ê²Œì„ ë©”íƒ€ë°ì´í„°';
COMMENT ON COLUMN public.generated_games.game_id IS 'ê²Œì„ í´ë”ëª… (ì˜ˆ: sensor-ball-game-abc123)';
COMMENT ON COLUMN public.generated_games.storage_path IS 'Supabase Storage ê²½ë¡œ';
COMMENT ON COLUMN public.generated_games.creator_id IS 'ê²Œì„ ìƒì„±ì (ê¶Œí•œ ê´€ë¦¬ìš©)';
COMMENT ON COLUMN public.generated_games.metadata IS 'ì¶”ê°€ ë©”íƒ€ë°ì´í„° (JSONB)';
```

**metadata JSONB êµ¬ì¡°**:
```json
{
  "version": "1.0",
  "validationScore": 97,
  "generationMetadata": {
    "model": "claude-sonnet-4-5-20250929",
    "inputTokens": 8342,
    "outputTokens": 42158,
    "cost": 0.1575,
    "generationTime": 35230
  },
  "tags": ["physics", "puzzle", "action"],
  "difficulty": "medium",
  "averagePlayTime": 180
}
```

**ìƒ˜í”Œ ë°ì´í„°**:
```sql
INSERT INTO public.generated_games (
    game_id,
    title,
    description,
    game_type,
    genre,
    storage_path,
    creator_id,
    metadata
) VALUES (
    'sensor-ball-game-abc123',
    'ì„¼ì„œ ë³¼ ê³¨ëŒ€ ê²Œì„',
    'ê¸°ìš¸ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µì„ ê³¨ëŒ€ê¹Œì§€ ìœ ë„í•˜ëŠ” ë¬¼ë¦¬ í¼ì¦ ê²Œì„',
    'solo',
    'physics',
    'sensor-ball-game-abc123/index.html',
    '550e8400-e29b-41d4-a716-446655440000',
    '{
        "version": "1.0",
        "validationScore": 97,
        "tags": ["physics", "puzzle"],
        "difficulty": "medium"
    }'::jsonb
);
```

### 2.2 game_versions í…Œì´ë¸”

**ìš©ë„**: ê²Œì„ ë²„ì „ ê´€ë¦¬ ë° ìˆ˜ì • ì´ë ¥ ì¶”ì 

```sql
CREATE TABLE public.game_versions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    game_id TEXT UNIQUE NOT NULL,
    current_version TEXT NOT NULL DEFAULT '1.0',
    title TEXT,
    description TEXT,
    game_type TEXT,
    modifications JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE public.game_versions IS 'ê²Œì„ ë²„ì „ ê´€ë¦¬';
COMMENT ON COLUMN public.game_versions.current_version IS 'Semantic Versioning (ì˜ˆ: 1.2.3)';
COMMENT ON COLUMN public.game_versions.modifications IS 'ìˆ˜ì • ì´ë ¥ ë°°ì—´ (JSONB)';
```

**modifications JSONB êµ¬ì¡°**:
```json
[
  {
    "type": "creation",
    "version": "1.0",
    "description": "ì´ˆê¸° ìƒì„±",
    "timestamp": "2025-01-10T10:30:00Z"
  },
  {
    "type": "bugfix",
    "version": "1.1",
    "description": "ì„¼ì„œ ë°ì´í„° null ì˜¤ë¥˜ ìˆ˜ì •",
    "timestamp": "2025-01-10T14:20:00Z"
  },
  {
    "type": "feature",
    "version": "1.2",
    "description": "ì ìˆ˜ ì‹œìŠ¤í…œ ì¶”ê°€",
    "timestamp": "2025-01-10T16:45:00Z"
  }
]
```

**ìƒ˜í”Œ ë°ì´í„°**:
```sql
INSERT INTO public.game_versions (
    game_id,
    current_version,
    title,
    modifications
) VALUES (
    'sensor-ball-game-abc123',
    '1.2',
    'ì„¼ì„œ ë³¼ ê³¨ëŒ€ ê²Œì„',
    '[
        {
            "type": "creation",
            "version": "1.0",
            "description": "ì´ˆê¸° ìƒì„±",
            "timestamp": "2025-01-10T10:30:00Z"
        },
        {
            "type": "bugfix",
            "version": "1.1",
            "description": "ë²½ ì¶©ëŒ ì˜¤ë¥˜ ìˆ˜ì •",
            "timestamp": "2025-01-10T14:20:00Z"
        },
        {
            "type": "feature",
            "version": "1.2",
            "description": "íƒ€ì´ë¨¸ ê¸°ëŠ¥ ì¶”ê°€",
            "timestamp": "2025-01-10T16:45:00Z"
        }
    ]'::jsonb
);
```

### 2.3 game_knowledge í…Œì´ë¸”

**ìš©ë„**: RAG ì‹œìŠ¤í…œì˜ ë²¡í„° ì €ì¥ì†Œ

```sql
CREATE TABLE public.game_knowledge (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    content TEXT NOT NULL,
    metadata JSONB DEFAULT '{}'::jsonb,
    embedding vector(1536),  -- OpenAI text-embedding-3-small
    created_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE public.game_knowledge IS 'RAG ë²¡í„° ì €ì¥ì†Œ';
COMMENT ON COLUMN public.game_knowledge.content IS 'ë¬¸ì„œ ì²­í¬ ë‚´ìš©';
COMMENT ON COLUMN public.game_knowledge.metadata IS 'ë¬¸ì„œ ë©”íƒ€ë°ì´í„° (ì¶œì²˜, íƒ€ì… ë“±)';
COMMENT ON COLUMN public.game_knowledge.embedding IS '1536 ì°¨ì› ë²¡í„° (OpenAI)';
```

**metadata JSONB êµ¬ì¡°**:
```json
{
  "source": "docs/PERFECT_GAME_DEVELOPMENT_GUIDE.md",
  "type": "guide",
  "size": 1234,
  "chunkIndex": 5,
  "totalChunks": 20
}
```

**ìƒ˜í”Œ ë°ì´í„°**:
```sql
INSERT INTO public.game_knowledge (
    content,
    metadata,
    embedding
) VALUES (
    'SessionSDK í†µí•© íŒ¨í„´:\n\nconst sdk = new SessionSDK(...);\n\nsdk.on(''connected'', async () => {\n    const session = await sdk.createSession();\n});',
    '{
        "source": "docs/SESSIONSK_INTEGRATION_PATTERNS.md",
        "type": "sdk",
        "size": 1500,
        "chunkIndex": 1
    }'::jsonb,
    '[0.023, -0.012, 0.045, ..., 0.018]'::vector(1536)
);
```

### 2.4 auth.users í…Œì´ë¸”

**ìš©ë„**: ì‚¬ìš©ì ì¸ì¦ (Supabase Auth ê¸°ë³¸ í…Œì´ë¸”)

```sql
-- Supabaseê°€ ìë™ ìƒì„±í•˜ëŠ” í…Œì´ë¸”
-- ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ

-- ì£¼ìš” ì»¬ëŸ¼:
-- id: UUID (ì‚¬ìš©ì ID)
-- email: TEXT (ì´ë©”ì¼)
-- encrypted_password: TEXT (ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸)
-- email_confirmed_at: TIMESTAMPTZ (ì´ë©”ì¼ ì¸ì¦ ì‹œê°„)
-- created_at: TIMESTAMPTZ
-- updated_at: TIMESTAMPTZ
```

**ê´€ë¦¬ì ê³„ì •**:
```
ì´ë©”ì¼: admin@admin.com
ì—­í• : ì „ì²´ ê²Œì„ ê´€ë¦¬ ê¶Œí•œ
```

---

## 3. RLS ì •ì±…

### 3.1 RLS ê°œìš”

**RLS (Row Level Security)**: PostgreSQLì˜ í–‰ ë‹¨ìœ„ ë³´ì•ˆ ì •ì±…

```sql
-- RLS í™œì„±í™”
ALTER TABLE public.generated_games ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.game_versions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.game_knowledge ENABLE ROW LEVEL SECURITY;
```

### 3.2 generated_games RLS ì •ì±…

#### SELECT ì •ì±… (ì½ê¸°)

```sql
-- ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê¸° ê°€ëŠ¥
CREATE POLICY "Anyone can read games"
ON public.generated_games
FOR SELECT
USING (true);
```

**ì„¤ëª…**: ê²Œì„ í”Œë ˆì´ë¥¼ ìœ„í•´ ëª¨ë“  ì‚¬ìš©ìê°€ ê²Œì„ ëª©ë¡ì„ ì¡°íšŒí•  ìˆ˜ ìˆì–´ì•¼ í•¨

#### INSERT ì •ì±… (ìƒì„±)

```sql
-- ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìƒì„± ê°€ëŠ¥, creator_id ê²€ì¦
CREATE POLICY "Authenticated users can insert games"
ON public.generated_games
FOR INSERT
TO authenticated
WITH CHECK (
    auth.uid() = creator_id
);
```

**ì„¤ëª…**:
- `TO authenticated`: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥
- `auth.uid() = creator_id`: ë³¸ì¸ì˜ IDê°€ creator_idì™€ ì¼ì¹˜í•´ì•¼ í•¨

#### UPDATE ì •ì±… (ìˆ˜ì •)

```sql
-- ê²Œì„ ì œì‘ì ë˜ëŠ” admin@admin.comë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Creator or admin can update games"
ON public.generated_games
FOR UPDATE
TO authenticated
USING (
    auth.uid() = creator_id OR
    auth.email() = 'admin@admin.com'
);
```

**ì„¤ëª…**:
- ë³¸ì¸ì´ ìƒì„±í•œ ê²Œì„ë§Œ ìˆ˜ì • ê°€ëŠ¥
- ë˜ëŠ” admin@admin.com ê³„ì •ì€ ëª¨ë“  ê²Œì„ ìˆ˜ì • ê°€ëŠ¥

#### DELETE ì •ì±… (ì‚­ì œ)

```sql
-- ê²Œì„ ì œì‘ì ë˜ëŠ” adminë§Œ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Creator or admin can delete games"
ON public.generated_games
FOR DELETE
TO authenticated
USING (
    auth.uid() = creator_id OR
    auth.email() = 'admin@admin.com'
);
```

### 3.3 game_knowledge RLS ì •ì±…

```sql
-- ëª¨ë“  ì‚¬ìš©ìê°€ ì½ê¸° ê°€ëŠ¥ (RAG ê²€ìƒ‰ìš©)
CREATE POLICY "Anyone can read knowledge"
ON public.game_knowledge
FOR SELECT
USING (true);

-- ê´€ë¦¬ìë§Œ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Only admin can modify knowledge"
ON public.game_knowledge
FOR ALL
TO authenticated
USING (auth.email() = 'admin@admin.com')
WITH CHECK (auth.email() = 'admin@admin.com');
```

### 3.4 RLS í…ŒìŠ¤íŠ¸

```sql
-- ì¼ë°˜ ì‚¬ìš©ìë¡œ í…ŒìŠ¤íŠ¸
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claims.sub TO '550e8400-e29b-41d4-a716-446655440000';
SET LOCAL request.jwt.claims.email TO 'user@example.com';

-- ë³¸ì¸ ê²Œì„ ì¡°íšŒ (ì„±ê³µ)
SELECT * FROM generated_games WHERE creator_id = '550e8400-e29b-41d4-a716-446655440000';

-- ë‹¤ë¥¸ ì‚¬ëŒ ê²Œì„ ìˆ˜ì • ì‹œë„ (ì‹¤íŒ¨)
UPDATE generated_games
SET title = 'Hacked'
WHERE creator_id != '550e8400-e29b-41d4-a716-446655440000';
-- Error: new row violates row-level security policy

-- ê´€ë¦¬ìë¡œ í…ŒìŠ¤íŠ¸
SET LOCAL request.jwt.claims.email TO 'admin@admin.com';

-- ëª¨ë“  ê²Œì„ ìˆ˜ì • ê°€ëŠ¥ (ì„±ê³µ)
UPDATE generated_games SET play_count = play_count + 1;
```

---

## 4. pgvector ë²¡í„° ê²€ìƒ‰

### 4.1 pgvector í™•ì¥ ì„¤ì¹˜

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### 4.2 ë²¡í„° ì¸ë±ìŠ¤ ìƒì„±

```sql
-- IVFFlat ì¸ë±ìŠ¤ (Inverted File with Flat)
CREATE INDEX game_knowledge_embedding_idx
ON public.game_knowledge
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

**ì¸ë±ìŠ¤ íŒŒë¼ë¯¸í„°**:
- `lists = 100`: í´ëŸ¬ìŠ¤í„° ê°œìˆ˜ (ê¶Œì¥: sqrt(í–‰ ìˆ˜))
- `vector_cosine_ops`: ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ì—°ì‚°ì

**ì¸ë±ìŠ¤ ì¢…ë¥˜ ë¹„êµ**:

| ì¸ë±ìŠ¤ | ì •í™•ë„ | ì†ë„ | ë©”ëª¨ë¦¬ |
|--------|--------|------|--------|
| **IVFFlat** | 95% | ë¹ ë¦„ | ì¤‘ê°„ |
| HNSW | 99% | ë§¤ìš° ë¹ ë¦„ | ë†’ìŒ |
| Flat (ì¸ë±ìŠ¤ ì—†ìŒ) | 100% | ëŠë¦¼ | ë‚®ìŒ |

### 4.3 ë²¡í„° ê²€ìƒ‰ í•¨ìˆ˜

```sql
CREATE OR REPLACE FUNCTION match_documents(
    query_embedding vector(1536),
    match_count INT DEFAULT 5,
    similarity_threshold FLOAT DEFAULT 0.7
)
RETURNS TABLE (
    content TEXT,
    metadata JSONB,
    similarity FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT
        game_knowledge.content,
        game_knowledge.metadata,
        1 - (game_knowledge.embedding <=> query_embedding) AS similarity
    FROM game_knowledge
    WHERE 1 - (game_knowledge.embedding <=> query_embedding) > similarity_threshold
    ORDER BY similarity DESC
    LIMIT match_count;
END;
$$;

COMMENT ON FUNCTION match_documents IS 'RAG ë²¡í„° ê²€ìƒ‰ (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)';
```

**ì—°ì‚°ì ì„¤ëª…**:
- `<=>`: ì½”ì‚¬ì¸ ê±°ë¦¬ (0 = ê°™ìŒ, 2 = ì •ë°˜ëŒ€)
- `1 - <=>`: ì½”ì‚¬ì¸ ìœ ì‚¬ë„ (0 = ë‹¤ë¦„, 1 = ê°™ìŒ)

### 4.4 ë²¡í„° ê²€ìƒ‰ ì˜ˆì‹œ

```sql
-- 1. ì¿¼ë¦¬ ì„ë² ë”© (í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìƒì„±)
-- const queryEmbedding = await openai.embeddings.create(...)

-- 2. ë²¡í„° ê²€ìƒ‰ ì‹¤í–‰
SELECT * FROM match_documents(
    '[0.023, -0.012, 0.045, ..., 0.018]'::vector(1536),  -- ì¿¼ë¦¬ ì„ë² ë”©
    5,      -- Top-5
    0.7     -- ìµœì†Œ ìœ ì‚¬ë„ 70%
);
```

**ê²°ê³¼ ì˜ˆì‹œ**:
```
content                                  | metadata                                      | similarity
-----------------------------------------|-----------------------------------------------|------------
"SessionSDK í†µí•© íŒ¨í„´:\n\n..."           | {"source": "SESSIONSK_PATTERNS.md", ...}     | 0.923
"ì„¼ì„œ ë°ì´í„° ì²˜ë¦¬:\n\n..."                | {"source": "SENSOR_GUIDE.md", ...}           | 0.887
"Canvas ë Œë”ë§ ìµœì í™”:\n\n..."            | {"source": "PERFORMANCE.md", ...}            | 0.852
"ë¬¼ë¦¬ ì—”ì§„ êµ¬í˜„:\n\n..."                  | {"source": "PHYSICS_ENGINE.md", ...}         | 0.821
"ë²„ê·¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…:\n\n..."                 | {"source": "TROUBLESHOOTING.md", ...}        | 0.758
```

### 4.5 ë²¡í„° ê²€ìƒ‰ ì„±ëŠ¥

```sql
-- ì„±ëŠ¥ ë¶„ì„
EXPLAIN ANALYZE
SELECT * FROM match_documents(
    '[...]'::vector(1536),
    5,
    0.7
);
```

**ê²°ê³¼**:
```
Planning Time: 0.234 ms
Execution Time: 1.456 ms
Index Scan using game_knowledge_embedding_idx
Rows Removed by Filter: 387
Rows Returned: 5
```

**ìµœì í™” íŒ**:
1. `lists` íŒŒë¼ë¯¸í„° ì¡°ì • (âˆší–‰ ìˆ˜)
2. `similarity_threshold` ë†’ì´ê¸° (ì •í™•ë„ vs ì†ë„)
3. ì •ê¸°ì ìœ¼ë¡œ `VACUUM ANALYZE` ì‹¤í–‰

---

## 5. ì¸ë±ìŠ¤ ì „ëµ

### 5.1 generated_games ì¸ë±ìŠ¤

```sql
-- 1. game_id ê³ ìœ  ì¸ë±ìŠ¤ (ìë™ ìƒì„±ë¨)
CREATE UNIQUE INDEX generated_games_game_id_idx
ON public.generated_games(game_id);

-- 2. game_type ì¸ë±ìŠ¤ (í•„í„°ë§ìš©)
CREATE INDEX generated_games_game_type_idx
ON public.generated_games(game_type);

-- 3. creator_id ì¸ë±ìŠ¤ (ê¶Œí•œ ê²€ì¦ìš©)
CREATE INDEX generated_games_creator_id_idx
ON public.generated_games(creator_id);

-- 4. created_at ì¸ë±ìŠ¤ (ì •ë ¬ìš©)
CREATE INDEX generated_games_created_at_idx
ON public.generated_games(created_at DESC);

-- 5. ë³µí•© ì¸ë±ìŠ¤ (creator_id + created_at)
CREATE INDEX generated_games_creator_created_idx
ON public.generated_games(creator_id, created_at DESC);
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```sql
-- ì¸ë±ìŠ¤ í™œìš© (game_type_idx)
SELECT * FROM generated_games
WHERE game_type = 'solo'
ORDER BY created_at DESC;

-- ì¸ë±ìŠ¤ í™œìš© (creator_created_idx)
SELECT * FROM generated_games
WHERE creator_id = '...'
ORDER BY created_at DESC;
```

### 5.2 game_knowledge ì¸ë±ìŠ¤

```sql
-- 1. ë²¡í„° ì¸ë±ìŠ¤ (ìœ„ì—ì„œ ìƒì„±)
CREATE INDEX game_knowledge_embedding_idx
ON public.game_knowledge
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 2. metadata GIN ì¸ë±ìŠ¤ (JSONB ê²€ìƒ‰ìš©)
CREATE INDEX game_knowledge_metadata_idx
ON public.game_knowledge
USING GIN (metadata);
```

**GIN ì¸ë±ìŠ¤ í™œìš©**:
```sql
-- íŠ¹ì • íƒ€ì… ë¬¸ì„œ ê²€ìƒ‰
SELECT * FROM game_knowledge
WHERE metadata @> '{"type": "guide"}'::jsonb;

-- íŠ¹ì • ì¶œì²˜ ë¬¸ì„œ ê²€ìƒ‰
SELECT * FROM game_knowledge
WHERE metadata->>'source' LIKE '%PERFECT_GAME%';
```

### 5.3 ì¸ë±ìŠ¤ ì‚¬ìš© í†µê³„

```sql
-- ì¸ë±ìŠ¤ ì‚¬ìš© í†µê³„ ì¡°íšŒ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

---

## 6. íŠ¸ë¦¬ê±° ë° í•¨ìˆ˜

### 6.1 updated_at ìë™ ì—…ë°ì´íŠ¸

```sql
-- íŠ¸ë¦¬ê±° í•¨ìˆ˜ ìƒì„±
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- generated_games íŠ¸ë¦¬ê±°
CREATE TRIGGER update_generated_games_updated_at
BEFORE UPDATE ON public.generated_games
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

-- game_versions íŠ¸ë¦¬ê±°
CREATE TRIGGER update_game_versions_updated_at
BEFORE UPDATE ON public.game_versions
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### 6.2 play_count ì¦ê°€ í•¨ìˆ˜

```sql
CREATE OR REPLACE FUNCTION increment_play_count(
    p_game_id TEXT
)
RETURNS VOID AS $$
BEGIN
    UPDATE public.generated_games
    SET play_count = play_count + 1
    WHERE game_id = p_game_id;
END;
$$ LANGUAGE plpgsql;

-- ì‚¬ìš© ì˜ˆì‹œ
SELECT increment_play_count('sensor-ball-game-abc123');
```

### 6.3 ê²Œì„ í†µê³„ ì¡°íšŒ í•¨ìˆ˜

```sql
CREATE OR REPLACE FUNCTION get_game_stats()
RETURNS TABLE (
    total_games BIGINT,
    solo_games BIGINT,
    dual_games BIGINT,
    multi_games BIGINT,
    total_plays BIGINT,
    avg_validation_score NUMERIC
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        COUNT(*)::BIGINT AS total_games,
        COUNT(*) FILTER (WHERE game_type = 'solo')::BIGINT AS solo_games,
        COUNT(*) FILTER (WHERE game_type = 'dual')::BIGINT AS dual_games,
        COUNT(*) FILTER (WHERE game_type = 'multi')::BIGINT AS multi_games,
        COALESCE(SUM(play_count), 0)::BIGINT AS total_plays,
        ROUND(AVG((metadata->>'validationScore')::NUMERIC), 2) AS avg_validation_score
    FROM public.generated_games;
END;
$$ LANGUAGE plpgsql;

-- ì‚¬ìš© ì˜ˆì‹œ
SELECT * FROM get_game_stats();
```

**ê²°ê³¼ ì˜ˆì‹œ**:
```
total_games | solo_games | dual_games | multi_games | total_plays | avg_validation_score
------------|------------|------------|-------------|-------------|-----------------------
    12      |      8     |     3      |      1      |    1,234    |        96.75
```

### 6.4 ë²„ì „ ì¦ê°€ í•¨ìˆ˜

```sql
CREATE OR REPLACE FUNCTION increment_game_version(
    p_game_id TEXT,
    p_version_type TEXT,  -- 'major', 'minor', 'patch'
    p_modification JSONB
)
RETURNS TEXT AS $$
DECLARE
    v_current_version TEXT;
    v_new_version TEXT;
    v_major INT;
    v_minor INT;
    v_patch INT;
BEGIN
    -- í˜„ì¬ ë²„ì „ ì¡°íšŒ
    SELECT current_version INTO v_current_version
    FROM public.game_versions
    WHERE game_id = p_game_id;

    -- ë²„ì „ íŒŒì‹±
    v_major := SPLIT_PART(v_current_version, '.', 1)::INT;
    v_minor := SPLIT_PART(v_current_version, '.', 2)::INT;
    v_patch := COALESCE(NULLIF(SPLIT_PART(v_current_version, '.', 3), ''), '0')::INT;

    -- ë²„ì „ ì¦ê°€
    IF p_version_type = 'major' THEN
        v_major := v_major + 1;
        v_minor := 0;
        v_patch := 0;
    ELSIF p_version_type = 'minor' THEN
        v_minor := v_minor + 1;
        v_patch := 0;
    ELSIF p_version_type = 'patch' THEN
        v_patch := v_patch + 1;
    END IF;

    v_new_version := v_major || '.' || v_minor || '.' || v_patch;

    -- ë²„ì „ ì—…ë°ì´íŠ¸
    UPDATE public.game_versions
    SET
        current_version = v_new_version,
        modifications = modifications || p_modification
    WHERE game_id = p_game_id;

    RETURN v_new_version;
END;
$$ LANGUAGE plpgsql;

-- ì‚¬ìš© ì˜ˆì‹œ
SELECT increment_game_version(
    'sensor-ball-game-abc123',
    'patch',
    '{"type": "bugfix", "description": "ë²½ ì¶©ëŒ ìˆ˜ì •", "timestamp": "2025-01-10T14:20:00Z"}'::jsonb
);
-- ê²°ê³¼: '1.0.1'
```

---

## 7. ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ë° ë³µêµ¬

### 7.1 ìë™ ë°±ì—… (Supabase)

```
Supabase ìë™ ë°±ì—…:
â”œâ”€ ë¹ˆë„: ë§¤ì¼ ìë™
â”œâ”€ ë³´ê´€ ê¸°ê°„: 7ì¼
â”œâ”€ ë³µêµ¬ ì‹œê°„: ~5ë¶„
â””â”€ ìˆ˜ë™ ë°±ì—…: Dashboardì—ì„œ ê°€ëŠ¥
```

### 7.2 ìˆ˜ë™ ë°±ì—… (pg_dump)

```bash
# ì „ì²´ DB ë°±ì—…
pg_dump -h db.rwkgktwdljsddowcxphc.supabase.co \
        -U postgres \
        -d postgres \
        -F c \
        -f backup_$(date +%Y%m%d).dump

# íŠ¹ì • í…Œì´ë¸”ë§Œ ë°±ì—…
pg_dump -h db.rwkgktwdljsddowcxphc.supabase.co \
        -U postgres \
        -d postgres \
        -t public.generated_games \
        -t public.game_versions \
        -F c \
        -f backup_games_$(date +%Y%m%d).dump
```

### 7.3 ë³µêµ¬

```bash
# ì „ì²´ DB ë³µêµ¬
pg_restore -h db.rwkgktwdljsddowcxphc.supabase.co \
           -U postgres \
           -d postgres \
           -c \
           backup_20250110.dump

# íŠ¹ì • í…Œì´ë¸”ë§Œ ë³µêµ¬
pg_restore -h db.rwkgktwdljsddowcxphc.supabase.co \
           -U postgres \
           -d postgres \
           -t generated_games \
           backup_games_20250110.dump
```

---

## 8. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### 8.1 ì¿¼ë¦¬ ì„±ëŠ¥ ë¶„ì„

```sql
-- ëŠë¦° ì¿¼ë¦¬ ì¡°íšŒ
SELECT
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
WHERE mean_time > 100  -- 100ms ì´ìƒ
ORDER BY mean_time DESC
LIMIT 10;
```

### 8.2 í…Œì´ë¸” í¬ê¸° ì¡°íšŒ

```sql
SELECT
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**ê²°ê³¼ ì˜ˆì‹œ**:
```
tablename         | size
------------------|--------
game_knowledge    | 120 MB
generated_games   | 2 MB
game_versions     | 1 MB
```

### 8.3 ì¸ë±ìŠ¤ íš¨ìœ¨ì„± ì¡°íšŒ

```sql
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan ASC;
```

---

**ë¬¸ì„œ ë**

ë‹¤ìŒ ë¬¸ì„œ: [05_í•µì‹¬_ëª¨ë“ˆ_ë¶„ì„.md](./05_í•µì‹¬_ëª¨ë“ˆ_ë¶„ì„.md)
